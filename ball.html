<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<title>Magic Ball Trick</title>

<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
}

html, body {
    width: 100%;
    height: 100%;
    overflow: hidden;
    background: black;
    touch-action: none;
}

#background {
    position: fixed;
    inset: 0;
    background-size: cover;
    background-position: center;
    z-index: 1;
}

/* BALL (IMAGE) */
#ball {
    position: absolute;
    max-width: 200px;
    height: auto;
    z-index: 2;
    touch-action: none;
    opacity: 1;
    transition: opacity 0.3s ease;
}

/* SETTINGS */
#settings {
    position: fixed;
    top: -100%;
    inset: 0;
    background: rgba(0,0,0,0.9);
    z-index: 10;
    padding: 20px;
    color: white;
    transition: top 0.5s ease;
}

button {
    padding: 10px 15px;
    border: none;
    border-radius: 6px;
    margin: 5px 0;
}

.file-upload {
    display: inline-block;
    padding: 10px;
    background: #2196F3;
    border-radius: 6px;
    cursor: pointer;
}

input[type=file] { display: none; }
</style>
</head>

<body>

<div id="background"></div>
<img id="ball" src="https://deckofcardsapi.com/static/img/AS.png">

<div id="settings">
    <h2>Settings</h2>

    <label class="file-upload">
        Upload Background
        <input type="file" id="bgUpload" accept="image/*">
    </label><br>

    <label class="file-upload">
        Upload Ball Image
        <input type="file" id="ballUpload" accept="image/*">
    </label><br>

    <button onclick="closeSettings()">Save & Close</button>
</div>

<script>
/* ================= STORAGE ================= */
const bg = document.getElementById('background');
const ball = document.getElementById('ball');

if (localStorage.bg) bg.style.backgroundImage = `url(${localStorage.bg})`;
if (localStorage.ball) ball.src = localStorage.ball;

/* ================= SETTINGS ================= */
let twoFingerStart = 0;

document.addEventListener('touchstart', e => {
    if (e.touches.length === 2) twoFingerStart = e.touches[0].clientY;
});

document.addEventListener('touchmove', e => {
    if (e.touches.length === 2) {
        if (e.touches[0].clientY - twoFingerStart > 100) {
            document.getElementById('settings').style.top = '0';
        }
    }
});

function closeSettings() {
    document.getElementById('settings').style.top = '-100%';
}

/* ================= UPLOAD ================= */
bgUpload.onchange = e => {
    const r = new FileReader();
    r.onload = ev => {
        bg.style.backgroundImage = `url(${ev.target.result})`;
        localStorage.bg = ev.target.result;
    };
    r.readAsDataURL(e.target.files[0]);
};

ballUpload.onchange = e => {
    const r = new FileReader();
    r.onload = ev => {
        ball.src = ev.target.result;
        localStorage.ball = ev.target.result;
        resetBall();
    };
    r.readAsDataURL(e.target.files[0]);
};

/* ================= BALL LOGIC (FROM MAGIC BALL) ================= */
let x, y;
let isTouching = false;
let visible = true;
let smoothBeta = 0;
let smoothGamma = 0;

const sensitivity = 0.35;
const smoothing = 0.15;
const exitThreshold = 80;

function resetBall(cx = innerWidth / 2, cy = innerHeight / 2) {
    ball.style.display = 'block';
    ball.style.opacity = '1';
    visible = true;
    x = cx;
    y = cy;
    updateBall();
}

function updateBall() {
    ball.style.transform =
        `translate(${x - ball.offsetWidth / 2}px, ${y - ball.offsetHeight / 2}px)`;
}

resetBall();

/* ================= SENSOR ================= */
if (typeof DeviceOrientationEvent?.requestPermission === 'function') {
    const btn = document.createElement('button');
    btn.textContent = 'Enable Motion';
    btn.style.cssText = `
        position:fixed; inset:0;
        background:black; color:white;
        font-size:24px; z-index:999;
    `;
    document.body.appendChild(btn);
    btn.onclick = async () => {
        if (await DeviceOrientationEvent.requestPermission() === 'granted') {
            btn.remove();
            listenSensor();
        }
    };
} else {
    listenSensor();
}

function listenSensor() {
    window.addEventListener('deviceorientation', e => {
        if (!visible || isTouching) return;
        smoothBeta += ((e.beta || 0) - smoothBeta) * smoothing;
        smoothGamma += ((e.gamma || 0) - smoothGamma) * smoothing;
    });
}

/* ================= TOUCH ================= */
ball.addEventListener('touchstart', e => {
    isTouching = true;
});

window.addEventListener('touchmove', e => {
    if (!isTouching || !visible) return;
    x = e.touches[0].clientX;
    y = e.touches[0].clientY;
    updateBall();

    if (
        x < -exitThreshold || x > innerWidth + exitThreshold ||
        y < -exitThreshold || y > innerHeight + exitThreshold
    ) hideBall();
}, { passive: false });

window.addEventListener('touchend', () => isTouching = false);

/* ================= HIDE / SHOW ================= */
function hideBall() {
    visible = false;
    ball.style.opacity = '0';
}

let lastTap = 0;
document.addEventListener('touchstart', e => {
    const now = Date.now();
    if (!visible && now - lastTap < 300) {
        resetBall(e.touches[0].clientX, e.touches[0].clientY);
    }
    lastTap = now;
});

/* ================= LOOP ================= */
function loop() {
    if (visible && !isTouching) {
        x += smoothGamma * sensitivity;
        y += smoothBeta * sensitivity;
        updateBall();
    }
    requestAnimationFrame(loop);
}
loop();
</script>

</body>
</html>
