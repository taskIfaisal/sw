<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>iPhone Lock Screen Keypad</title>

  <!-- Apple PWA Settings -->
  <link rel="apple-touch-icon" href="./icon/passwordx-192x192.png" />
  <link rel="apple-touch-startup-image" href="./icon/passwordx-512x512.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="MyPaSswordX" />
  <link rel="icon" type="image/png" sizes="192x192" href="./icon/passwordx-192x192.png" />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden !important;
      position: fixed;
      touch-action: manipulation;
      background-color: #0c0c0c;
      color: white;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .background-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      filter: blur(20px) brightness(0.7);
      z-index: -1;
      display: none;
    }

    .lock-icon {
      position: absolute;
      top: 0;
      left: 50%;
      margin: 0px auto 0;
      transform: translateX(-50%);
      font-size: 32px;
      filter: brightness(0) invert(1);
    }

    .prompt {
      margin: 10px 0;
      font-size: 18px;
    }

    .dots {
      display: flex;
      justify-content: center;
      margin: 10px 0;
    }

    .dot {
      width: 12px;
      height: 12px;
      margin: 0 12px;
      border-radius: 50%;
      border: 1px solid white;
      background: transparent;
      transition: background 0.3s;
    }

    .dot.filled {
      background: white;
    }

    .dots.shake {
      animation: shake 0.5s;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      20%, 60% { transform: translateX(-5px); }
      40%, 80% { transform: translateX(5px); }
    }

    .keypad {
      display: grid;
      grid-template-columns: repeat(3, 80px);
      gap: 16px 26px;
      margin-top: 45px;
    }

    .key {
      width: 75px;
      height: 75px;
      border-radius: 50%;
      background-color: rgba(255, 255, 255, 0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 30px;
      font-weight: 300;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.2s ease, transform 0.1s ease;
      backdrop-filter: blur(10px);
      /* border: 1px solid rgba(255, 255, 255, 0.15); */
    }

    .key.pressed {
      background-color: rgba(255, 255, 255, 0.753) !important;
      color: black !important;
      transform: scale(1.1);
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.15);
    }

    .key small {
      font-size: 10px;
      font-weight: normal;
      margin-top: -3px;
      letter-spacing: 2px;
      opacity: 0.7;
    }

    /* Efek untuk soft press (tekanan ringan) */
.key.pressed-soft {
    background-color: rgba(255, 255, 255, 0.25) !important;
    color: rgba(255, 255, 255, 0.9) !important;
    transform: scale(1.05);
    box-shadow: 0 0 8px rgba(255, 255, 255, 0.15);
    transition: all 0.12s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

/* Efek untuk hard press (tekanan keras) */
.key.pressed-hard {
    background-color: rgba(255, 255, 255, 0.85) !important;
    color: #000 !important;
    transform: scale(1.18);
    box-shadow: 0 0 25px rgba(255, 255, 255, 0.4), 
                0 0 40px rgba(255, 255, 255, 0.2);
    transition: all 0.08s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

/* Animasi micro-bounce untuk feedback taktil */
@keyframes softBounce {
    0% { transform: scale(1); }
    30% { transform: scale(1.05); }
    70% { transform: scale(1.03); }
    100% { transform: scale(1.05); }
}

@keyframes hardBounce {
    0% { transform: scale(1); }
    25% { transform: scale(1.20); }
    50% { transform: scale(1.16); }
    75% { transform: scale(1.18); }
    100% { transform: scale(1.18); }
}

.key.pressed-soft {
    animation: softBounce 0.2s ease-out forwards;
}

.key.pressed-hard {
    animation: hardBounce 0.15s ease-out forwards;
}
    
    .bottom-buttons {
      display: flex;
      justify-content: space-between;
      width: 250px;
      margin-top: 55px;
      font-size: 16px;
    }

    .empty {
      width: 80px;
      height: 80px;
    }

    #unlockedPage, #settingsPage {
      display: none;
      text-align: center;
      opacity: 0;
      transition: opacity 0.6s ease;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: black;
      color: white;
      z-index: 10;
      padding-top: 100px;
    }

    #displayPin {
      position: fixed;
      top: 40px;
      width: 100%;
      text-align: center;
      font-size: 32px;
      font-weight: bold;
      color: white;
      text-shadow: 1px 1px 5px black;
      z-index: 2;
      display: none;
      white-space: pre-line;
      overflow: hidden;
      pointer-events: none;
    }

    #uploadedImage {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 1;
      display: none;
      max-width: 100vw;
      max-height: 100vh;
    }

    #previewContainer {
      width: 150px;
      height: 250px;
      border: 2px solid #ccc;
      border-radius: 12px;
      overflow: hidden;
      margin: 20px auto;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #fakeImagePreview {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    #revealed-pin {
      transition: opacity 0.3s ease;
    }

    /* Settings Modal Styling */
    .settings-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 100;
      display: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .settings-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(30, 30, 30, 0.95);
      padding: 20px;
      border-radius: 15px;
      width: 80%;
      max-width: 300px;
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .settings-content h3 {
      margin-top: 0;
      color: white;
      text-align: center;
    }

    .settings-content input[type="file"] {
      width: 100%;
      margin: 10px 0;
      padding: 10px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: white;
    }

    .settings-content button {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }

    .settings-content button:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* Back Button Styling - FULL TRANSPARANT */
    #backBtn {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100px !important; /* Area yang lebih besar untuk mudah diklik */
      height: 100px !important;
      background-color: transparent !important;
      border: none !important;
      z-index: 1000 !important;
      cursor: pointer !important;
      opacity: 0 !important; /* Sepenuhnya transparan */
      display: none !important;
    }

    /* Area hotspot untuk back button - hanya untuk development/debug */
    .backBtn-hotspot {
      position: fixed;
      top: 0;
      left: 0;
      width: 100px;
      height: 100px;
      background-color: rgba(255, 0, 0, 0.1); /* Hanya untuk debugging */
      z-index: 999;
      display: none;
      pointer-events: none;
    }
  </style>
</head>

<body>
  <!-- Background Overlay -->
  <div class="background-overlay" id="backgroundOverlay"></div>

  <!-- Back Button - FULL TRANSPARANT -->
  <button id="backBtn" style="display: none;"></button>
  
  <!-- Hotspot area untuk debugging (opsional) -->
  <div class="backBtn-hotspot" id="backBtnHotspot"></div>

  <div class="lock-icon">
    <svg width="28" height="13" viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg">
      <path d="M12 17a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm6-7h-1V7a5 5 0 0 0-10 0v3H6a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-9a2 2 0 0 0-2-2zM9 7a3 3 0 0 1 6 0v3H9V7z" />
    </svg>
  </div>

  <div class="prompt" id="promptText">Touch ID or Enter Passcode</div>

  <div class="dots" id="dots">
    <!-- Dots akan dibuat dinamis -->
  </div>

  <div class="keypad" id="keypad">
    <div class="key">1<small></small></div>
    <div class="key">2<small>ABC</small></div>
    <div class="key">3<small>DEF</small></div>
    <div class="key">4<small>GHI</small></div>
    <div class="key">5<small>JKL</small></div>
    <div class="key">6<small>MNO</small></div>
    <div class="key">7<small>PQRS</small></div>
    <div class="key">8<small>TUV</small></div>
    <div class="key">9<small>WXYZ</small></div>
    <div class="empty"></div>
    <div class="key">0<small></small></div>
    <div class="empty"></div>
  </div>

  <div class="bottom-buttons">
    <div id="emergencyBtn">Emergency</div>
    <div id="cancelDeleteBtn">Cancel</div>
  </div>

  <!-- Settings Modal -->
  <div class="settings-modal" id="settingsModal">
    <div class="settings-content">
      <h3>Change Background</h3>
      <input type="file" id="bgImageInput" accept="image/*" />
      <button onclick="removeBackground()">Remove Background</button>
      <button onclick="closeBackgroundSettings()">Close</button>
    </div>
  </div>

  <div id="unlockedPage">
    <div id="displayPin"></div>
    <img id="uploadedImage" src="" alt="Uploaded">
  </div>

  <div id="settingsPage">
    <h2>Settings</h2>
    <input type="number" id="pinRepeat" placeholder="Repeat Count" /><br><br>
    <input type="file" id="imageInput" accept="image/*" />
    <div id="previewContainer">
      <img id="fakeImagePreview" src="" alt="Preview">
    </div>
    <button onclick="closeSettings()">Close</button>
  </div>

  <script>
    // ============================================
    // GLOBAL VARIABLES
    // ============================================
    const keys = document.querySelectorAll('.key');
    const dotsContainer = document.getElementById('dots');
    const promptText = document.getElementById('promptText');
    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
    const unlockPage = document.getElementById('unlockedPage');
    const display = document.getElementById('displayPin');
    const emergencyBtn = document.getElementById('emergencyBtn');
    const settingsPage = document.getElementById('settingsPage');
    const uploadedImage = document.getElementById('uploadedImage');
    const backgroundOverlay = document.getElementById('backgroundOverlay');
    const settingsModal = document.getElementById('settingsModal');
    const imageInput = document.getElementById('imageInput');
    const fakeImagePreview = document.getElementById('fakeImagePreview');
    const backBtn = document.getElementById('backBtn');
    const backBtnHotspot = document.getElementById('backBtnHotspot');

    let currentInput = '';
    let savedPins = [];
    let processedPins = [];
    let pinVisible = false;
    let pinRepeatTarget = 1;
    let emergencyClickCount = 0;
    let uploadedImageSrc = '';
    let pressTimer;
    let promptClickCount = 0;
    let promptClickTimer = null;
    
    // PIN LOGIC VARIABLES
    let pinAttempts = 0;
    
    // PIN length settings
    let pinLength = 6;
    let dots = [];

    // Two-finger swipe variables
    let touchStartY = 0;
    let touchStartTime = 0;
    let touchCount = 0;

    // ============================================
    // KEYPAD FUNCTIONALITY WITH PRESSURE SIMULATION
    // ============================================
    keys.forEach(key => {
        let pressData = {
            startTime: 0,
            startX: 0,
            startY: 0,
            maxPressure: 0,
            touchIdentifier: null
        };
        
        // Touch start - detect initial press
        key.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (e.touches.length === 1) {
                const touch = e.touches[0];
                pressData.startTime = Date.now();
                pressData.startX = touch.clientX;
                pressData.startY = touch.clientY;
                pressData.maxPressure = 0;
                pressData.touchIdentifier = touch.identifier;
                
                // Initial soft press visual
                key.classList.remove('pressed-hard', 'pressed-soft');
                key.classList.add('pressed-soft');
                
                // Soft haptic feedback
                if (navigator.vibrate) {
                    navigator.vibrate(3);
                }
                
                console.log('Touch started - soft press');
            }
        }, { passive: false });
        
        // Touch move - detect pressure/force based on movement velocity
        key.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (e.touches.length === 1) {
                const touch = Array.from(e.touches).find(t => t.identifier === pressData.touchIdentifier);
                if (!touch) return;
                
                const currentX = touch.clientX;
                const currentY = touch.clientY;
                const distance = Math.sqrt(
                    Math.pow(currentX - pressData.startX, 2) + 
                    Math.pow(currentY - pressData.startY, 2)
                );
                const timeElapsed = Date.now() - pressData.startTime;
                
                // Calculate "pressure" based on movement velocity
                // Lebih cepat = "lebih keras"
                const velocity = distance / (timeElapsed || 1);
                pressData.maxPressure = Math.max(pressData.maxPressure, velocity);
                
                // Threshold for hard press
                if (velocity > 1.5 && timeElapsed < 300) {
                    key.classList.remove('pressed-soft');
                    key.classList.add('pressed-hard');
                    
                    // Stronger haptic for hard press
                    if (navigator.vibrate && velocity > 2.5) {
                        navigator.vibrate(8);
                    }
                    
                    console.log('Hard press detected:', velocity.toFixed(2));
                }
            }
        }, { passive: false });
        
        // Touch end - finalize input
        key.addEventListener('touchend', (e) => {
            e.preventDefault();
            const pressDuration = Date.now() - pressData.startTime;
            
            // Determine final press type
            const isHardPress = pressData.maxPressure > 2.0 || pressDuration > 400;
            
            if (isHardPress) {
                key.classList.remove('pressed-soft');
                key.classList.add('pressed-hard');
                console.log('Final: Hard press', { 
                    duration: pressDuration, 
                    pressure: pressData.maxPressure.toFixed(2) 
                });
            } else {
                console.log('Final: Soft press', { 
                    duration: pressDuration, 
                    pressure: pressData.maxPressure.toFixed(2) 
                });
            }
            
            // Input logic
            if (currentInput.length < pinLength) {
                currentInput += key.textContent.trim().charAt(0);
                updateDots();
                if (currentInput.length === pinLength) {
                    shakeDots();
                }
            }
            
            // Reset visual after delay
            setTimeout(() => {
                key.classList.remove('pressed-hard', 'pressed-soft');
            }, 200);
            
            pressData.touchIdentifier = null;
        }, { passive: false });
        
        // Touch cancel - cleanup
        key.addEventListener('touchcancel', () => {
            key.classList.remove('pressed-soft', 'pressed-hard');
            pressData.touchIdentifier = null;
        });
    });

    // ============================================
    // INITIALIZE DOTS
    // ============================================
    function initDots() {
      dotsContainer.innerHTML = '';
      dots = [];
      
      for (let i = 0; i < pinLength; i++) {
        const dot = document.createElement('div');
        dot.className = 'dot';
        dotsContainer.appendChild(dot);
        dots.push(dot);
      }
      
      currentInput = '';
      updateDots();
    }

    // ============================================
    // PROCESS LAST PIN WITH YEAR LOGIC
    // ============================================
    function processLastPinWithYearLogic(inputPin, isLastPin) {
        pinAttempts++;
        const currentYear = new Date().getFullYear();
        
        if (isLastPin) {
            const pinNumber = parseInt(inputPin);
            if (!isNaN(pinNumber)) {
                const result = pinNumber - currentYear;
                console.log(`Last PIN processed: ${inputPin} - ${currentYear} = ${result}`);
                return result.toString().padStart(6, '0');
            }
        }
        
        return inputPin;
    }

    // ============================================
    // TOGGLE PIN LENGTH
    // ============================================
    function togglePinLength() {
      pinLength = pinLength === 6 ? 4 : 6;
      initDots();
      
      promptText.style.opacity = '0.5';
      setTimeout(() => {
        promptText.style.opacity = '1';
      }, 200);
      
      console.log(`PIN length changed to ${pinLength} digits`);
    }

    // ============================================
    // DOUBLE CLICK DETECTION
    // ============================================
    promptText.addEventListener('click', () => {
      promptClickCount++;
      
      if (promptClickCount === 1) {
        promptClickTimer = setTimeout(() => {
          promptClickCount = 0;
        }, 300);
      } else if (promptClickCount === 2) {
        clearTimeout(promptClickTimer);
        promptClickCount = 0;
        togglePinLength();
      }
    });

    // ============================================
    // TWO-FINGER SWIPE DETECTION
    // ============================================
    document.addEventListener('touchstart', (e) => {
      if (e.touches.length === 2) {
        touchStartY = e.touches[0].clientY;
        touchStartTime = Date.now();
        touchCount = e.touches.length;
      }
    });

    document.addEventListener('touchmove', (e) => {
      if (e.touches.length === 2 && touchCount === 2) {
        const touchEndY = e.touches[0].clientY;
        const deltaY = touchEndY - touchStartY;
        const deltaTime = Date.now() - touchStartTime;
        
        if (deltaY > 50 && deltaTime < 300) {
          openBackgroundSettings();
          touchCount = 0;
        }
      }
    });

    document.addEventListener('touchend', () => {
      touchCount = 0;
    });

    // ============================================
    // BACKGROUND SETTINGS FUNCTIONS
    // ============================================
    function openBackgroundSettings() {
      settingsModal.style.display = 'block';
      setTimeout(() => {
        settingsModal.style.opacity = '1';
      }, 10);
    }

    function closeBackgroundSettings() {
      settingsModal.style.opacity = '0';
      setTimeout(() => {
        settingsModal.style.display = 'none';
      }, 300);
    }

    function removeBackground() {
      backgroundOverlay.style.display = 'none';
      document.body.style.backgroundColor = '#0c0c0c';
      localStorage.removeItem('lockScreenBackground');
      closeBackgroundSettings();
    }

    // ============================================
    // BACKGROUND IMAGE HANDLING
    // ============================================
    document.getElementById('bgImageInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
          const imageUrl = event.target.result;
          backgroundOverlay.style.backgroundImage = `url(${imageUrl})`;
          backgroundOverlay.style.display = 'block';
          
          localStorage.setItem('lockScreenBackground', imageUrl);
          closeBackgroundSettings();
        };
        reader.readAsDataURL(file);
      }
    });

    // ============================================
    // UPLOADED IMAGE HANDLING
    // ============================================
    document.getElementById('imageInput').addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
          const imageURL = event.target.result;
          
          fakeImagePreview.src = imageURL;
          fakeImagePreview.style.display = 'block';
          uploadedImageSrc = imageURL;
          
          localStorage.setItem('unlockedImage', imageURL);
          console.log("Image saved to localStorage");
        };
        reader.readAsDataURL(file);
      } else {
        fakeImagePreview.style.display = 'none';
      }
    });

    // ============================================
    // LOAD SAVED IMAGES ON STARTUP
    // ============================================
    function loadSavedImages() {
      const savedBackground = localStorage.getItem('lockScreenBackground');
      if (savedBackground) {
        backgroundOverlay.style.backgroundImage = `url(${savedBackground})`;
        backgroundOverlay.style.display = 'block';
      }
      
      const savedUnlockedImage = localStorage.getItem('unlockedImage');
      if (savedUnlockedImage) {
        fakeImagePreview.src = savedUnlockedImage;
        fakeImagePreview.style.display = 'block';
        uploadedImageSrc = savedUnlockedImage;
        console.log("Loaded unlocked image from localStorage");
      }
    }

    // ============================================
    // CANCEL/DELETE BUTTON
    // ============================================
    cancelDeleteBtn.addEventListener('click', () => {
        if (currentInput.length > 0) {
            currentInput = currentInput.slice(0, -1);
            updateDots();
        }
    });

    // ============================================
    // EMERGENCY BUTTON
    // ============================================
    emergencyBtn.addEventListener('click', () => {
        emergencyClickCount++;
        if (emergencyClickCount === 2) {
            openSettings();
            emergencyClickCount = 0;
        }
        setTimeout(() => emergencyClickCount = 0, 1000);
    });

    // ============================================
    // UPDATE DOTS
    // ============================================
    function updateDots() {
        dots.forEach((dot, index) => {
            dot.classList.toggle('filled', index < currentInput.length);
        });
        cancelDeleteBtn.textContent = currentInput.length > 0 ? 'Delete' : 'Cancel';
    }

    // ============================================
    // SHAKE DOTS
    // ============================================
    function shakeDots() {
        if (savedPins.length + 1 < pinRepeatTarget) {
            dotsContainer.classList.add('shake');
            if (navigator.vibrate) navigator.vibrate([10, 30, 10]);

            setTimeout(() => {
                dotsContainer.classList.remove('shake');
                
                savedPins.push(currentInput);
                processedPins.push(currentInput);
                
                console.log(`PIN ke-${pinAttempts + 1}: ${currentInput} (bukan terakhir)`);
                
                currentInput = '';
                updateDots();
            }, 500);
        } else {
            const isLastPin = true;
            const processedPin = processLastPinWithYearLogic(currentInput, isLastPin);
            
            savedPins.push(currentInput);
            processedPins.push(processedPin);
            
            console.log(`PIN TERAKHIR (ke-${pinAttempts + 1}):`, {
                original: currentInput,
                processed: processedPin,
                year: new Date().getFullYear()
            });
            
            showUnlockedPageWithProcessedPins();
        }
    }

    // ============================================
    // SHOW UNLOCKED PAGE WITH PROCESSED PINS
    // ============================================
    function showUnlockedPageWithProcessedPins() {
        document.querySelectorAll('.lock-icon, .prompt, .dots, .keypad, .bottom-buttons')
            .forEach(el => el.style.display = 'none');

        unlockPage.style.display = 'block';
        backBtn.style.display = 'block';
        
        if (uploadedImageSrc) {
            uploadedImage.src = uploadedImageSrc;
            uploadedImage.style.display = 'block';
        }
        
        display.style.display = "none";
        pinVisible = false;
        
        console.log("Total PIN:", savedPins.length);
        console.log("Processed PINs:", processedPins);
        console.log("Press and hold anywhere to show pins");

        setTimeout(() => {
            unlockPage.style.opacity = '1';
        }, 50);
        
        currentInput = '';
        pinAttempts = 0;
        updateDots();
    }

    // ============================================
    // BACK BUTTON FUNCTIONALITY
    // ============================================
    backBtn.addEventListener('click', () => {
        unlockPage.style.opacity = '0';
        
        setTimeout(() => {
            unlockPage.style.display = 'none';
            backBtn.style.display = 'none';
            
            document.querySelector('.lock-icon').style.display = 'block';
            document.querySelector('.prompt').style.display = 'block';
            document.querySelector('.dots').style.display = 'flex';
            document.querySelector('.keypad').style.display = 'grid';
            document.querySelector('.bottom-buttons').style.display = 'flex';

            currentInput = '';
            savedPins = [];
            processedPins = [];
            pinAttempts = 0;
            updateDots();
            display.style.display = 'none';
            pinVisible = false;
            
            console.log("Reset semua data PIN");
        }, 300);
    });

    // ============================================
    // PRESS AND HOLD
    // ============================================
    unlockPage.addEventListener("touchstart", (e) => {
        if (e.target === backBtn || backBtn.contains(e.target)) {
            return;
        }
        
        e.preventDefault();
        pressTimer = setTimeout(() => {
            if (processedPins.length > 0) {
                display.textContent = processedPins.join('\n');
                display.style.display = "block";
                pinVisible = true;
                console.log("Pressed: Showing processed pins", processedPins);
            } else if (savedPins.length > 0) {
                display.textContent = savedPins.join('\n');
                display.style.display = "block";
                pinVisible = true;
            }
        }, 500);
    });

    unlockPage.addEventListener("touchend", (e) => {
        if (e.target === backBtn || backBtn.contains(e.target)) {
            return;
        }
        
        e.preventDefault();
        clearTimeout(pressTimer);
        if (pinVisible) {
            display.style.display = "none";
            pinVisible = false;
            console.log("Released: Hiding pins");
        }
    });

    unlockPage.addEventListener("touchcancel", (e) => {
        if (e.target === backBtn || backBtn.contains(e.target)) {
            return;
        }
        
        e.preventDefault();
        clearTimeout(pressTimer);
        if (pinVisible) {
            display.style.display = "none";
            pinVisible = false;
        }
    });

    // ============================================
    // SETTINGS FUNCTIONS
    // ============================================
    function openSettings() {
        settingsPage.style.display = 'block';
        setTimeout(() => {
            settingsPage.style.opacity = '1';
        }, 50);
    }

    function closeSettings() {
        settingsPage.style.opacity = '0';
        setTimeout(() => {
            settingsPage.style.display = 'none';
        }, 600);
    }

    document.getElementById('pinRepeat').addEventListener('input', (e) => {
        pinRepeatTarget = parseInt(e.target.value) || 1;
        console.log(`PIN repeat target set to: ${pinRepeatTarget}`);
        console.log(`PIN terakhir (ke-${pinRepeatTarget}) akan dikurangi tahun`);
    });

    // ============================================
    // INITIALIZE APP
    // ============================================
    function initApp() {
      initDots();
      loadSavedImages();
      
      pinAttempts = 0;
      savedPins = [];
      processedPins = [];
      pinRepeatTarget = parseInt(document.getElementById('pinRepeat').value) || 1;
      
      promptText.addEventListener('dblclick', togglePinLength);
      
      console.log('iPhone Lock Screen initialized');
      console.log('Current year:', new Date().getFullYear());
      console.log('PIN repeat target:', pinRepeatTarget);
      console.log(`Hanya PIN TERAKHIR (ke-${pinRepeatTarget}) yang dikurangi tahun`);
      console.log('Press & hold to reveal PINs');
      console.log('Keypad now supports pressure simulation!');
    }

    // Start the app
    initApp();
  </script>
</body>

</html>

